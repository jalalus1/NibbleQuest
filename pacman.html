<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>NibbleQuest - NovaPixel Studio</title>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      margin: 0;
    }

    h1 {
      margin: 10px 0 0;
      font-size: 24px;
    }

    #info {
      margin: 5px 0 5px;
      font-size: 14px;
    }

    #topbar {
      display: flex;
      gap: 20px;
      margin-bottom: 10px;
      font-size: 16px;
    }

    canvas {
      border: 2px solid #fff;
      background: #000;
    }

    #message {
      margin-top: 10px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      min-height: 24px;
    }

    /* BaÅŸlangÄ±Ã§ ekranÄ± overlay */
    #startOverlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #222, #000);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      color: #fff;
    }

    .intro-text {
      font-size: 24px;
      letter-spacing: 2px;
      opacity: 0;
      animation: fadeInOut 3s forwards;
    }

    .game-title {
      font-size: 40px;
      font-weight: bold;
      margin-top: 10px;
      color: #ffeb3b;
      text-shadow: 0 0 10px #ffeb3b;
      opacity: 0;
      animation: fadeInScale 3s forwards;
      animation-delay: 2s;
    }

    #startBtn {
      margin-top: 40px;
      padding: 10px 30px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #ffeb3b;
      color: #000;
      font-weight: bold;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 1s forwards;
      animation-delay: 4s;
    }

    #startBtn:hover {
      box-shadow: 0 0 10px #ffeb3b;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(10px); }
      20% { opacity: 1; transform: translateY(0); }
      80% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-10px); }
    }

    @keyframes fadeInScale {
      0% { opacity: 0; transform: scale(0.7); }
      40% { opacity: 1; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }

    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(15px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    /* KAZANMA EKRANI + KONFETÄ° */
    #winOverlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 20;
      overflow: hidden;
      color: #fff;
    }

    /* Arkaplanda yanÄ±p sÃ¶nen renkli Ä±ÅŸÄ±k efekti */
    #winOverlay::before {
      content: "";
      position: absolute;
      inset: -20%;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,64,129,0.7), transparent 60%),
        radial-gradient(circle at 80% 30%, rgba(33,150,243,0.7), transparent 55%),
        radial-gradient(circle at 30% 80%, rgba(76,175,80,0.7), transparent 55%),
        radial-gradient(circle at 70% 75%, rgba(255,235,59,0.8), transparent 55%);
      filter: blur(2px);
      opacity: 0.7;
      animation: lightsPulse 3s infinite alternate;
      z-index: 20;
    }

    @keyframes lightsPulse {
      0% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.05); }
      100% { opacity: 0.6; transform: scale(1.02); }
    }

    #confettiCanvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 21;
    }

    .win-content {
      position: relative;
      z-index: 22;
      text-align: center;
    }

    .win-title {
      font-size: 64px;
      font-weight: 900;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: #ffeb3b;
      text-shadow:
        0 0 10px #ffeb3b,
        0 0 20px #ffeb3b,
        0 0 40px #ff9800;
      animation: winTitleGlow 1.5s infinite alternate;
    }

    @keyframes winTitleGlow {
      0% { transform: scale(1); text-shadow: 0 0 10px #ffeb3b; }
      100% { transform: scale(1.05); text-shadow: 0 0 25px #ff9800; }
    }

    .win-subtitle {
      margin-top: 12px;
      font-size: 22px;
      text-shadow: 0 0 6px rgba(0,0,0,0.8);
    }
  </style>
</head>
<body>
  <h1>NibbleQuest</h1>
  <div id="info">Ok tuÅŸlarÄ± ile hareket et. TÃ¼m noktalarÄ± ye, hayaletlere yakalanma!</div>
  <div id="topbar">
    <div id="score">Skor: 0</div>
    <div id="level">BÃ¶lÃ¼m: 1 / 15</div>
    <div id="lives">Can: 5</div>
  </div>
  <canvas id="game" width="380" height="140"></canvas>
  <div id="message"></div>

  <!-- BaÅŸlangÄ±Ã§ ekranÄ± -->
  <div id="startOverlay">
    <div class="intro-text">NovaPixel Studio presents</div>
    <div class="game-title">NibbleQuest</div>
    <button id="startBtn">BAÅžLA</button>
  </div>

  <!-- Kazanma ekranÄ± + konfeti -->
  <div id="winOverlay">
    <canvas id="confettiCanvas"></canvas>
    <div class="win-content">
      <div class="win-title">TEBRÄ°KLER!</div>
      <div class="win-subtitle">NibbleQuest'i baÅŸarÄ±yla bitirdin ðŸŽ‰</div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score");
    const levelEl = document.getElementById("level");
    const messageEl = document.getElementById("message");
    const livesEl = document.getElementById("lives");

    const startOverlay = document.getElementById("startOverlay");
    const startBtn = document.getElementById("startBtn");

    const winOverlay = document.getElementById("winOverlay");
    const confettiCanvas = document.getElementById("confettiCanvas");
    const confettiCtx = confettiCanvas.getContext("2d");

    const tileSize = 20;

    // 5 temel harita â€“ 15 level iÃ§in dÃ¶nÃ¼ÅŸÃ¼mlÃ¼ kullanÄ±lacak (zorluk ghost'larla da artÄ±yor)
    const baseMaps = [
      // MAP 0 â€“ Klasik, dengeli
      [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,2,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,2,1,1,2,1,2,1,1,2,1,1,1,2,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,2,1,1,1,1,1,1,1,2,1,1,1,2,1],
        [1,2,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
      ],
      // MAP 1 â€“ biraz daha labirentli
      [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,2,2,2,1,2,2,2,2,1,2,2,2,2,1,2,2,2,1],
        [1,2,1,2,1,2,1,1,2,1,2,1,1,2,1,2,1,2,1],
        [1,2,1,2,2,2,2,2,2,2,2,2,2,2,2,2,1,2,1],
        [1,2,1,1,1,2,1,1,1,1,1,1,1,2,1,1,1,2,1],
        [1,2,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
      ],
      // MAP 2 â€“ ortasÄ± biraz kapalÄ±, daha dar yollar
      [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,2,2,2,1,2,2,2,2,1,2,2,2,2,1,2,2,2,1],
        [1,2,1,2,1,2,1,1,2,1,2,1,1,2,1,2,1,2,1],
        [1,2,2,2,2,2,2,1,2,2,2,1,2,2,2,2,2,2,1],
        [1,2,1,1,1,2,1,1,1,1,1,1,1,2,1,1,1,2,1],
        [1,2,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
      ],
      // MAP 3 â€“ daha fazla duvar, merkezde koridorlar
      [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,2,2,2,2,2,1,2,2,1,2,2,1,2,2,2,2,2,1],
        [1,2,1,1,1,2,1,1,2,1,2,1,1,2,1,1,1,2,1],
        [1,2,2,2,1,2,2,2,2,2,2,2,2,2,1,2,2,2,1],
        [1,2,1,1,1,2,1,1,1,1,1,1,1,2,1,1,1,2,1],
        [1,2,2,2,2,2,1,2,2,1,2,2,1,2,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
      ],
      // MAP 4 â€“ daha keskin, kenarlarda yollar
      [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,2,2,2,2,1,2,2,2,1,2,2,2,1,2,2,2,2,1],
        [1,2,1,1,2,1,2,1,2,1,2,1,2,1,2,1,1,2,1],
        [1,2,2,1,2,2,2,1,2,2,2,1,2,2,2,1,2,2,1],
        [1,2,1,1,2,1,2,1,1,1,1,1,2,1,2,1,1,2,1],
        [1,2,2,2,2,1,2,2,2,1,2,2,2,1,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
      ]
    ];

    // 15 level iÃ§in config â€“ her level mapIndex, start ve hayaletler ile tanÄ±mlanÄ±yor
    const levelConfigs = [
      // Level 1â€“3: hafif, 2 hayalet
      { mapIndex: 0, pacmanStart: { row: 1, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 1.2 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 1.2 }
      ]},
      { mapIndex: 0, pacmanStart: { row: 1, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 1.3 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 1.3 }
      ]},
      { mapIndex: 1, pacmanStart: { row: 1, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 1.4 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 1.4 }
      ]},

      // Level 4â€“6: orta, 2 hayalet ama daha hÄ±zlÄ±
      { mapIndex: 1, pacmanStart: { row: 1, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 1.5 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 1.5 }
      ]},
      { mapIndex: 2, pacmanStart: { row: 1, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 1.6 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 1.6 }
      ]},
      { mapIndex: 2, pacmanStart: { row: 1, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 1.7 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 1.7 }
      ]},

      // Level 7â€“9: 3 hayalet, orta hÄ±z
      { mapIndex: 3, pacmanStart: { row: 1, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 1.7 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 1.7 },
        { row: 3, col: 9,  dirX: 0,  dirY: 1,  speed: 1.6 }
      ]},
      { mapIndex: 3, pacmanStart: { row: 1, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 1.8 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 1.8 },
        { row: 3, col: 9,  dirX: 0,  dirY: 1,  speed: 1.7 }
      ]},
      { mapIndex: 4, pacmanStart: { row: 1, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 1.9 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 1.9 },
        { row: 3, col: 9,  dirX: 0,  dirY: 1,  speed: 1.8 }
      ]},

      // Level 10â€“12: zor, 3 hayalet daha hÄ±zlÄ±
      { mapIndex: 4, pacmanStart: { row: 1, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 2.0 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 2.0 },
        { row: 3, col: 9,  dirX: 0,  dirY: 1,  speed: 1.9 }
      ]},
      { mapIndex: 0, pacmanStart: { row: 3, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 2.0 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 2.0 },
        { row: 3, col: 9,  dirX: 0,  dirY: 1,  speed: 2.0 }
      ]},
      { mapIndex: 1, pacmanStart: { row: 3, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 2.1 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 2.1 },
        { row: 3, col: 9,  dirX: 0,  dirY: 1,  speed: 2.0 }
      ]},

      // Level 13â€“15: en zor, 3 hayalet yÃ¼ksek hÄ±z
      { mapIndex: 2, pacmanStart: { row: 3, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 2.1 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 2.1 },
        { row: 3, col: 9,  dirX: 0,  dirY: 1,  speed: 2.1 }
      ]},
      { mapIndex: 3, pacmanStart: { row: 3, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 2.2 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 2.2 },
        { row: 3, col: 9,  dirX: 0,  dirY: 1,  speed: 2.1 }
      ]},
      { mapIndex: 4, pacmanStart: { row: 3, col: 1 }, ghosts: [
        { row: 1, col: 17, dirX: -1, dirY: 0, speed: 2.3 },
        { row: 5, col: 17, dirX: 0,  dirY: -1, speed: 2.3 },
        { row: 3, col: 9,  dirX: 0,  dirY: 1,  speed: 2.2 }
      ]}
    ];

    const totalLevels = levelConfigs.length;

    let currentLevel = 0;
    let map;
    let rows, cols;
    let pacman;
    let ghosts = [];
    let score = 0;
    let lives = 5;
    let gameOver = false;
    let win = false;
    let isRunning = false;
    let mouthPhase = 0;

    // Konfeti deÄŸiÅŸkenleri
    let confettiPieces = [];
    let confettiRunning = false;

    function cloneMap(sourceMap) {
      return sourceMap.map(row => row.slice());
    }

    function updateUI() {
      scoreEl.textContent = "Skor: " + score;
      levelEl.textContent = `BÃ¶lÃ¼m: ${currentLevel + 1} / ${totalLevels}`;
      livesEl.textContent = "Can: " + lives;
    }

    function initLevel(levelIndex) {
      const cfg = levelConfigs[levelIndex];
      map = cloneMap(baseMaps[cfg.mapIndex]);
      rows = map.length;
      cols = map[0].length;

      canvas.width = cols * tileSize;
      canvas.height = rows * tileSize;

      resetPositions();
      messageEl.textContent = levelIndex === 0 ? "" : `BÃ¶lÃ¼m ${levelIndex + 1}! (+1 can aldÄ±n)`;
      updateUI();
    }

    function resetPositions() {
      const cfg = levelConfigs[currentLevel];
      const start = cfg.pacmanStart;

      pacman = {
        x: start.col * tileSize + tileSize / 2,
        y: start.row * tileSize + tileSize / 2,
        radius: tileSize / 2 - 3,
        speed: 2,
        dirX: 1,
        dirY: 0,
        nextDirX: 1,
        nextDirY: 0
      };

      ghosts = cfg.ghosts.map(g => ({
        x: g.col * tileSize + tileSize / 2,
        y: g.row * tileSize + tileSize / 2,
        speed: g.speed,
        dirX: g.dirX,
        dirY: g.dirY
      }));
    }

    // Klavye kontrolÃ¼
    window.addEventListener("keydown", (e) => {
      if (!isRunning || gameOver || win) return;

      if (e.key === "ArrowLeft") {
        pacman.nextDirX = -1; pacman.nextDirY = 0;
      } else if (e.key === "ArrowRight") {
        pacman.nextDirX = 1; pacman.nextDirY = 0;
      } else if (e.key === "ArrowUp") {
        pacman.nextDirX = 0; pacman.nextDirY = -1;
      } else if (e.key === "ArrowDown") {
        pacman.nextDirX = 0; pacman.nextDirY = 1;
      }
    });

    function getTileAt(row, col) {
      if (row < 0 || row >= rows || col < 0 || col >= cols) return 1;
      return map[row][col];
    }

    function getTile(x, y) {
      const col = Math.floor(x / tileSize);
      const row = Math.floor(y / tileSize);
      return getTileAt(row, col);
    }

    function canMove(x, y, dirX, dirY, speed, radius) {
      const newX = x + dirX * speed;
      const newY = y + dirY * speed;

      const left   = newX - radius;
      const right  = newX + radius;
      const top    = newY - radius;
      const bottom = newY + radius;

      const tilesToCheck = [
        getTile(left, top),
        getTile(right, top),
        getTile(left, bottom),
        getTile(right, bottom)
      ];

      return tilesToCheck.every(t => t !== 1);
    }

    function updatePacman() {
      // Ã–nce istenen yÃ¶ne dÃ¶nebiliyor mu?
      if (canMove(pacman.x, pacman.y, pacman.nextDirX, pacman.nextDirY, pacman.speed, pacman.radius)) {
        pacman.dirX = pacman.nextDirX;
        pacman.dirY = pacman.nextDirY;
      }

      // Åžu anki yÃ¶nde ilerleyebiliyor mu?
      if (canMove(pacman.x, pacman.y, pacman.dirX, pacman.dirY, pacman.speed, pacman.radius)) {
        pacman.x += pacman.dirX * pacman.speed;
        pacman.y += pacman.dirY * pacman.speed;
      }

      // Nokta yeme
      const col = Math.floor(pacman.x / tileSize);
      const row = Math.floor(pacman.y / tileSize);
      if (map[row][col] === 2) {
        map[row][col] = 0;
        score += 10;
        updateUI();
      }

      // TÃ¼m noktalar bitti mi?
      if (remainingDots() === 0) {
        // Her bÃ¶lÃ¼m bitiÅŸinde +1 can
        lives++;
        updateUI();

        if (currentLevel < totalLevels - 1) {
          currentLevel++;
          initLevel(currentLevel);
        } else if (!win) {
          win = true;
          messageEl.textContent = "Tebrikler, tÃ¼m 15 bÃ¶lÃ¼mÃ¼ bitirdin! ðŸŽ‰ (+1 bonus can)";
          showWinOverlay();
        }
      }
    }

    function remainingDots() {
      let count = 0;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (map[r][c] === 2) count++;
        }
      }
      return count;
    }

    function handleHit() {
      lives--;
      updateUI();

      if (lives > 0) {
        messageEl.textContent = `Hayalete Ã§arptÄ±n! Kalan can: ${lives}`;
        resetPositions();
      } else {
        gameOver = true;
        messageEl.textContent = "Game Over! TÃ¼m canlar bitti. ðŸ˜¢ Yeniden baÅŸlamak iÃ§in sayfayÄ± yenile.";
      }
    }

    // Hayalet hareketi â€“ tile merkezlerinde yÃ¶n seÃ§erek tÃ¼m haritaya yayÄ±lÄ±yorlar
    function updateGhosts() {
      const ghostRadius = tileSize / 2 - 4;

      for (let i = 0; i < ghosts.length; i++) {
        const g = ghosts[i];

        let col = Math.floor(g.x / tileSize);
        let row = Math.floor(g.y / tileSize);
        const centerX = col * tileSize + tileSize / 2;
        const centerY = row * tileSize + tileSize / 2;

        const atCenter = Math.abs(g.x - centerX) < 1 && Math.abs(g.y - centerY) < 1;

        if (atCenter) {
          g.x = centerX;
          g.y = centerY;

          const dirs = [
            {x: 1, y: 0},
            {x: -1, y: 0},
            {x: 0, y: 1},
            {x: 0, y: -1}
          ];

          let possible = [];
          for (const d of dirs) {
            const nr = row + d.y;
            const nc = col + d.x;
            if (getTileAt(nr, nc) !== 1) {
              possible.push(d);
            }
          }

          if (possible.length > 1) {
            possible = possible.filter(d => !(d.x === -g.dirX && d.y === -g.dirY));
            if (possible.length === 0) {
              possible = dirs.filter(d => getTileAt(row + d.y, col + d.x) !== 1);
            }
          }

          const choice = possible[Math.floor(Math.random() * possible.length)];
          g.dirX = choice.x;
          g.dirY = choice.y;
        }

        if (canMove(g.x, g.y, g.dirX, g.dirY, g.speed, ghostRadius)) {
          g.x += g.dirX * g.speed;
          g.y += g.dirY * g.speed;
        } else {
          g.dirX = -g.dirX;
          g.dirY = -g.dirY;
        }

        const dx = g.x - pacman.x;
        const dy = g.y - pacman.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < pacman.radius) {
          handleHit();
          break;
        }
      }
    }

    function drawMap() {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const tile = map[r][c];
          const x = c * tileSize;
          const y = r * tileSize;

          if (tile === 1) {
            ctx.fillStyle = "#0033ff";
            ctx.fillRect(x, y, tileSize, tileSize);
          } else {
            ctx.fillStyle = "#000";
            ctx.fillRect(x, y, tileSize, tileSize);
            if (tile === 2) {
              ctx.beginPath();
              ctx.arc(x + tileSize / 2, y + tileSize / 2, 3, 0, Math.PI * 2);
              ctx.fillStyle = "#fff";
              ctx.fill();
            }
          }
        }
      }
    }

    // YÃ¶ne gÃ¶re dÃ¶nen ve aÄŸÄ±z aÃ§Ä±lÄ±p kapanan normal Pac-Man
    function drawPacman() {
      let baseAngle = 0;
      if (pacman.dirX === 1) {
        baseAngle = 0;
      } else if (pacman.dirX === -1) {
        baseAngle = Math.PI;
      } else if (pacman.dirY === -1) {
        baseAngle = -Math.PI / 2;
      } else if (pacman.dirY === 1) {
        baseAngle = Math.PI / 2;
      }

      mouthPhase += 0.15;
      const mouthBase = 0.25 * Math.PI;
      const mouthAmp  = 0.10 * Math.PI;
      const mouthAngle = mouthBase + Math.sin(mouthPhase) * mouthAmp;

      ctx.beginPath();
      ctx.moveTo(pacman.x, pacman.y);
      ctx.arc(
        pacman.x,
        pacman.y,
        pacman.radius,
        baseAngle + mouthAngle,
        baseAngle - mouthAngle,
        false
      );
      ctx.closePath();
      ctx.fillStyle = "yellow";
      ctx.fill();

      const eyeOffset = 5;
      const eyeX = pacman.x + Math.cos(baseAngle - Math.PI / 2) * eyeOffset;
      const eyeY = pacman.y + Math.sin(baseAngle - Math.PI / 2) * eyeOffset;
      ctx.beginPath();
      ctx.arc(eyeX, eyeY, 2, 0, Math.PI * 2);
      ctx.fillStyle = "#000";
      ctx.fill();
    }

    function drawGhosts() {
      const ghostRadius = tileSize / 2 - 4;
      ghosts.forEach((g, index) => {
        ctx.beginPath();
        ctx.arc(g.x, g.y, ghostRadius, Math.PI, 0);
        ctx.lineTo(g.x + ghostRadius, g.y + ghostRadius);
        ctx.lineTo(g.x - ghostRadius, g.y + ghostRadius);
        ctx.closePath();
        ctx.fillStyle = index === 0 ? "red" : "cyan";
        ctx.fill();
      });
    }

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      drawMap();
      drawPacman();
      drawGhosts();

      if (isRunning && !gameOver && !win) {
        updatePacman();
        updateGhosts();
      }

      requestAnimationFrame(gameLoop);
    }

    // KONFETÄ°
    function resizeConfetti() {
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
    }

    function createConfettiPieces(count) {
      confettiPieces = [];
      const colors = ["#ffeb3b", "#ff4081", "#40c4ff", "#69f0ae", "#ff9100"];
      for (let i = 0; i < count; i++) {
        confettiPieces.push({
          x: Math.random() * confettiCanvas.width,
          y: Math.random() * confettiCanvas.height - confettiCanvas.height,
          vx: (Math.random() - 0.5) * 2,
          vy: 2 + Math.random() * 3,
          size: 4 + Math.random() * 6,
          color: colors[Math.floor(Math.random() * colors.length)],
          rotation: Math.random() * Math.PI * 2,
          vr: (Math.random() - 0.5) * 0.2
        });
      }
    }

    function updateConfetti() {
      for (const p of confettiPieces) {
        p.x += p.vx;
        p.y += p.vy;
        p.rotation += p.vr;

        if (p.y > confettiCanvas.height + 10) {
          p.y = -10;
          p.x = Math.random() * confettiCanvas.width;
        }
      }
    }

    function drawConfetti() {
      confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      for (const p of confettiPieces) {
        confettiCtx.save();
        confettiCtx.translate(p.x, p.y);
        confettiCtx.rotate(p.rotation);
        confettiCtx.fillStyle = p.color;
        confettiCtx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
        confettiCtx.restore();
      }
    }

    function confettiLoop() {
      if (!confettiRunning) return;
      updateConfetti();
      drawConfetti();
      requestAnimationFrame(confettiLoop);
    }

    function startConfetti() {
      resizeConfetti();
      createConfettiPieces(200);
      confettiRunning = true;
      confettiLoop();
    }

    window.addEventListener("resize", () => {
      if (confettiRunning) resizeConfetti();
    });

    function showWinOverlay() {
      winOverlay.style.display = "flex";
      startConfetti();
    }

    // BaÅŸla butonu
    startBtn.addEventListener("click", () => {
      startOverlay.style.display = "none";
      isRunning = true;
      messageEl.textContent = "";
    });

    // Oyunu baÅŸlat
    initLevel(currentLevel);
    gameLoop();
  </script>
</body>
</html>
